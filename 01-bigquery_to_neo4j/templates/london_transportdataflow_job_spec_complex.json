{
  "version": "1",
  "config": {
    "reset_db": true
  },
  "sources": [
    {
      "type": "bigquery",
      "name": "stations",
      "query": "SELECT ID, Station_Name, Latitude, Longitude, Zone, Postcode FROM `team-connectors-dev.london_transport.london_stations`"
    },
    {
      "type": "bigquery",
      "name": "tube_lines",
      "query": "SELECT Tube_Line, From_Station, To_Station FROM `team-connectors-dev.london_transport.london_tube_lines`"
    }
  ],
  "targets": {
    "nodes": [
      {
        "source": "stations",
        "name": "Station",
        "write_mode": "merge",
        "source_transformations": {
          "enable_grouping": true
        },
        "labels": [
          "Station"
        ],
        "properties": [
          {
            "source_field": "ID",
            "target_property": "station_id"
          },
          {
            "source_field": "Station_Name",
            "target_property": "name",
            "target_property_type": "string"
          },
          {
            "source_field": "Zone",
            "target_property": "zone",
            "target_property_type": "string"
          },
          {
            "source_field": "Postcode",
            "target_property": "postcode",
            "target_property_type": "string"
          },
          {
            "source_field": "Longitude",
            "target_property": "longitude",
            "target_property_type": "float"
          },
          {
            "source_field": "Latitude",
            "target_property": "latitude",
            "target_property_type": "string"
          }
        ],
        "schema": {
          "key_constraints": [
            {
              "name": "station_id",
              "label": "Station",
              "properties": [
                "station_id"
              ]
            }
          ],
          "range_indexes": [
            {
              "name": "ix_station_name",
              "label": "Station",
              "properties": [
                "name"
              ]
            }
          ]
        }
      }
    ],
    "queries": [
      {
        "source": "tube_lines",
        "name": "Tube Lines",
        "query": "UNWIND $rows as row MATCH (a:Station), (b:Station) WHERE a.name = row.From_Station AND b.name = row.To_Station CALL apoc.create.relationship(a, toUpper(row.Tube_Line), {}, b) YIELD rel as rel1 CALL apoc.create.relationship(b, toUpper(row.Tube_Line), {}, a) YIELD rel as rel2 RETURN rel1, rel2",
        "depends_on": [
          "Station"
        ]
      }
    ]
  }
}